<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GB28181 流播放器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 {
            margin-bottom: 15px;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        input[type="text"] {
            flex: 1;
            min-width: 300px;
            padding: 10px;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .video-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            padding-top: 56.25%; /* 16:9 aspect ratio */
        }
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        .info-panel {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #3d3d3d;
            border-radius: 4px;
        }
        .info-label {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .info-value {
            color: #fff;
            font-size: 14px;
            word-break: break-all;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #28a745;
        }
        .status.error {
            background: #dc3545;
        }
        .status.info {
            background: #17a2b8;
        }
        .stream-list {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
        }
        .stream-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #3d3d3d;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .stream-item:hover {
            background: #4d4d4d;
        }
        .stream-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stream-info {
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GB28181 流播放器</h1>
            <div class="controls">
                <input type="text" id="streamInput" placeholder="输入流名称，例如: live/34020000001320000001" value="">
                <button id="playBtn" onclick="playStream()">播放</button>
                <button id="stopBtn" onclick="stopStream()" disabled>停止</button>
                <button onclick="loadStreamList()">刷新流列表</button>
            </div>
            <div id="status" class="status info">准备就绪</div>
        </div>

        <div class="video-container">
            <video id="videoPlayer" controls></video>
        </div>

        <div class="info-panel">
            <h2>播放信息</h2>
            <div class="info-item">
                <div class="info-label">当前流地址</div>
                <div class="info-value" id="currentStream">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">HTTP-FLV 地址</div>
                <div class="info-value" id="flvUrl">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">HLS 地址</div>
                <div class="info-value" id="hlsUrl">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">RTMP 地址</div>
                <div class="info-value" id="rtmpUrl">-</div>
            </div>
        </div>

        <div class="stream-list">
            <h2>可用流列表</h2>
            <div id="streamList">加载中...</div>
        </div>
    </div>

    <script>
        let player = null;
        let currentStream = '';

        // 从 URL 参数获取流名称
        const urlParams = new URLSearchParams(window.location.search);
        const streamParam = urlParams.get('stream');
        if (streamParam) {
            document.getElementById('streamInput').value = streamParam;
        }

        // 加载流列表
        async function loadStreamList() {
            const listDiv = document.getElementById('streamList');
            listDiv.innerHTML = '加载中...';
            
            try {
                const response = await fetch('http://localhost:1986/api/v1/streams/');
                const data = await response.json();
                
                if (data.streams && data.streams.length > 0) {
                    let html = '';
                    data.streams.forEach(stream => {
                        const streamPath = `${stream.app}/${stream.name}`;
                        const video = stream.video || {};
                        html += `
                            <div class="stream-item" onclick="playStreamByName('${streamPath}')">
                                <div class="stream-name">${streamPath}</div>
                                <div class="stream-info">
                                    FPS: ${video.fps || 0} | 
                                    码率: ${video.kbps || 0} kbps | 
                                    分辨率: ${video.width || 0}x${video.height || 0}
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p style="color: #aaa;">当前没有活跃的流</p>';
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: #dc3545;">加载失败: ${error.message}</p>`;
            }
        }

        // 播放指定流名称
        function playStreamByName(streamName) {
            document.getElementById('streamInput').value = streamName;
            playStream();
        }

        // 播放流
        function playStream() {
            const streamInput = document.getElementById('streamInput').value.trim();
            if (!streamInput) {
                updateStatus('请输入流名称', 'error');
                return;
            }

            currentStream = streamInput;
            const baseUrl = 'http://localhost:9090';
            
            // 更新 URL 信息
            document.getElementById('currentStream').textContent = currentStream;
            document.getElementById('flvUrl').textContent = `${baseUrl}/${currentStream}.flv`;
            document.getElementById('hlsUrl').textContent = `${baseUrl}/${currentStream}.m3u8`;
            document.getElementById('rtmpUrl').textContent = `rtmp://localhost:1936/${currentStream}`;

            const video = document.getElementById('videoPlayer');
            
            // 优先使用 HLS（浏览器兼容性更好）
            const hlsUrl = `${baseUrl}/${currentStream}.m3u8`;
            const flvUrl = `${baseUrl}/${currentStream}.flv`;

            // 尝试使用 HLS
            if (Hls.isSupported()) {
                if (player) {
                    player.destroy();
                }
                player = new Hls();
                player.loadSource(hlsUrl);
                player.attachMedia(video);
                player.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                    updateStatus('正在播放 (HLS)', 'success');
                    document.getElementById('playBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                });
                player.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        updateStatus('HLS 播放失败，尝试 FLV', 'error');
                        // 尝试 FLV
                        tryFlvPlayback(flvUrl);
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari 原生 HLS 支持
                video.src = hlsUrl;
                video.play();
                updateStatus('正在播放 (HLS - Safari)', 'success');
                document.getElementById('playBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
            } else {
                // 尝试 FLV
                tryFlvPlayback(flvUrl);
            }
        }

        // 尝试 FLV 播放
        function tryFlvPlayback(flvUrl) {
            updateStatus('尝试 FLV 播放...', 'info');
            // 注意：浏览器原生不支持 FLV，需要使用 flv.js
            // 这里提供一个下载链接提示
            updateStatus('浏览器不支持直接播放 FLV，请使用 VLC 或其他播放器', 'error');
            document.getElementById('flvUrl').innerHTML = 
                `<a href="${flvUrl}" target="_blank" style="color: #007bff;">${flvUrl}</a> (右键下载或使用 VLC 播放)`;
        }

        // 停止播放
        function stopStream() {
            const video = document.getElementById('videoPlayer');
            video.pause();
            video.src = '';
            
            if (player) {
                player.destroy();
                player = null;
            }
            
            updateStatus('已停止播放', 'info');
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            currentStream = '';
        }

        // 更新状态
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // 页面加载时自动加载流列表
        window.onload = function() {
            loadStreamList();
            // 每 10 秒自动刷新流列表
            setInterval(loadStreamList, 10000);
        };

        // 回车键播放
        document.getElementById('streamInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                playStream();
            }
        });
    </script>
    <!-- HLS.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</body>
</html>

